name: Lab09 - Generate Diff PDF

on:
  push:
    branches: [master]

permissions:
  contents: read
  packages: read

jobs:
  diff-pdf:
    runs-on: ubuntu-latest

    container:
      image: ghcr.io/${{ github.repository }}:latex
      credentials:
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0   # full history

      - name: Generate git diff
        run: |
          BEFORE="${{ github.event.before }}"
          AFTER="${{ github.sha }}"

          if [ "$BEFORE" = "0000000000000000000000000000000000000000" ]; then
            echo "Initial commit, no diff available" > diff.txt
            exit 0
          fi

          git fetch origin "$BEFORE" --depth=1
          git fetch origin "$AFTER" --depth=1

          git diff "$BEFORE" "$AFTER" > diff.txt

      - name: Create LaTeX document for diff
        run: |
          cat << 'EOF' > diff.tex
          \documentclass[a4paper,11pt]{article}
          \usepackage[T1]{fontenc}
          \usepackage[utf8]{inputenc}
          \usepackage{geometry}
          \usepackage{fancyvrb}
          \geometry{margin=1in}
          \setlength{\parindent}{0pt}

          \begin{document}

          \section*{Git Diff}
          Commit range:\\
          \texttt{${{ github.event.before }} â†’ ${{ github.sha }}}

          \bigskip

          \begin{Verbatim}[fontsize=\small]
          EOF

          cat diff.txt >> diff.tex

          cat << 'EOF' >> diff.tex
          \end{Verbatim}
          \end{document}
          EOF

      - name: Compile diff PDF
        run: |
          latexmk -pdf -interaction=nonstopmode diff.tex

      - name: Upload diff PDF artifact
        uses: actions/upload-artifact@v4
        with:
          name: lab09-diff-pdf
          path: diff.pdf
