name: Lab09 - Generate Diff PDF

on:
  push:
    branches: [master]

permissions:
  contents: read
  packages: read

jobs:
  diff-pdf:
    runs-on: ubuntu-latest

    container:
      image: ghcr.io/${{ github.repository }}:latex
      credentials:
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    steps:
      # Checkout full history
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0   # required to fetch previous commits

      # Configure Git safe.directory and generate diff
      - name: Generate git diff
        run: |
          # Fix dubious ownership error in container
          git config --global --add safe.directory "$(pwd)"

          BEFORE="${{ github.event.before }}"
          AFTER="${{ github.sha }}"

          echo "Before commit: $BEFORE"
          echo "After commit:  $AFTER"

          # Initial commit: no diff available
          if [ "$BEFORE" = "0000000000000000000000000000000000000000" ]; then
            echo "Initial commit, no diff available" > diff.txt
            exit 0
          fi

          # Fetch commits explicitly to ensure they exist locally
          git fetch origin "$BEFORE" --depth=1
          git fetch origin "$AFTER" --depth=1

          # Generate the diff
          git diff "$BEFORE" "$AFTER" > diff.txt

          - name: Create LaTeX document for diff
          run: |
            cat << 'EOF' > diff.tex
            \documentclass[a4paper,11pt]{article}
            \usepackage[T1]{fontenc}
            \usepackage[utf8]{inputenc}
            \usepackage{geometry}
            \usepackage{xcolor}
            \usepackage{listings}
            \geometry{margin=1in}
            \setlength{\parindent}{0pt}
        
            \lstdefinestyle{gitdiff}{
                basicstyle=\ttfamily\small,
                morecomment=[l][\color{red}]{-},
                morecomment=[l][\color{green!60!black}]{+}
            }
        
            \begin{document}
        
            \section*{Git Diff}
            Commit range:\\
            \texttt{${{ github.event.before }}} â†’ \texttt{${{ github.sha }}}
        
            \bigskip
        
            \lstset{style=gitdiff}
            \lstinputlisting{diff.txt}
        
            \end{document}
            EOF
        
      # Compile the LaTeX document into a PDF
      - name: Compile diff PDF
        run: |
          latexmk -pdf -interaction=nonstopmode diff.tex

      # Upload the PDF as an artifact
      - name: Upload diff PDF artifact
        uses: actions/upload-artifact@v4
        with:
          name: lab09-diff-pdf
          path: diff.pdf
