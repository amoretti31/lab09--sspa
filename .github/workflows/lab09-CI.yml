name: Lab09 - Full CI + Preview

on:
  push:
    branches: [master]
  pull_request:
    branches: [master]

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  full-ci:
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/${{ github.repository }}:latex
      credentials:
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Git safe.directory
        run: git config --global --add safe.directory "$(pwd)"

      - name: Generate git diff
        run: |
          mkdir -p artifacts/diff
          BEFORE="${{ github.event.before }}"
          AFTER="${{ github.sha }}"
          if [ "$BEFORE" = "0000000000000000000000000000000000000000" ]; then
            echo "Initial commit, no diff available" > artifacts/diff/diff.txt
          else
            git fetch origin "$BEFORE" --depth=1
            git fetch origin "$AFTER" --depth=1
            git diff "$BEFORE" "$AFTER" > artifacts/diff/diff.txt
          fi

          cat << 'EOF' > diff.tex
          \documentclass[a4paper,11pt]{article}
          \usepackage[T1]{fontenc}
          \usepackage[utf8]{inputenc}
          \usepackage{geometry}
          \usepackage{xcolor}
          \usepackage{listings}
          \geometry{margin=1in}
          \setlength{\parindent}{0pt}

          \lstdefinestyle{gitdiff}{
              basicstyle=\ttfamily\small,
              morecomment=[l][\color{red}]{-},
              morecomment=[l][\color{green!60!black}]{+}
          }

          \lstset{
              style=gitdiff,
              breaklines=true,
              postbreak=\mbox{\textcolor{red}{$\hookrightarrow$}\space}
          }

          \begin{document}
          \section*{Git Diff}
          Commit range:\\
          \texttt{${{ github.event.before }}} -- \texttt{${{ github.sha }}}
          \bigskip
          \lstinputlisting{artifacts/diff/diff.txt}
          \end{document}
          EOF

          latexmk -pdf -interaction=nonstopmode diff.tex
          mv diff.pdf artifacts/diff/

      - name: Compile main PDF
        run: |
          mkdir -p artifacts/main
          latexmk -pdf -interaction=nonstopmode main.tex
          mv main.pdf artifacts/main/

      - name: Spellcheck .tex files
        run: |
          mkdir -p artifacts/spellcheck
          for file in $(find . -name "*.tex"); do
            hunspell -l -t "$file" > artifacts/spellcheck/$(basename "$file").txt || true
          done

      - name: Check bibliography
        run: |
          mkdir -p artifacts/bib
          for file in $(find . -name "main.tex"); do
            pdflatex -interaction=nonstopmode "$file" >/dev/null 2>&1
            bibtex "${file%.tex}" >/dev/null 2>&1 || echo "Bibtex failed for $file" >> artifacts/bib/bib_errors.txt
          done

      - name: Upload all artifacts
        uses: actions/upload-artifact@v4
        with:
          name: lab09-full-artifacts
          path: artifacts/

  publish:
    runs-on: ubuntu-latest
    needs: full-ci
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: lab09-full-artifacts
          path: artifacts

      - name: Publish PDFs for preview
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./artifacts
          destination_dir: lab09-preview
          publish_branch: gh-pages
