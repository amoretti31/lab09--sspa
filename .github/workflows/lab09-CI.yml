name: Lab09 - Full CI

on:
  push:
    branches: [master]
  pull_request:
    branches: [master]

permissions:
  contents: read

jobs:
  full-ci:
    runs-on: ubuntu-latest

    container:
      image: ghcr.io/${{ github.repository }}:latex
      credentials:
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    steps:
      # Step 1: Checkout repository with full history
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # Step 2: Fix Git safe.directory
      - name: Git safe.directory
        run: git config --global --add safe.directory "$(pwd)"

      # Step 3: Generate git diff
      - name: Generate git diff
        run: |
          mkdir -p artifacts/diff
          BEFORE="${{ github.event.before }}"
          AFTER="${{ github.sha }}"
          if [ "$BEFORE" = "0000000000000000000000000000000000000000" ]; then
            echo "Initial commit, no diff available" > artifacts/diff/diff.txt
          else
            git fetch origin "$BEFORE" --depth=1
            git fetch origin "$AFTER" --depth=1
            git diff "$BEFORE" "$AFTER" > artifacts/diff/diff.txt
          fi

          # Create LaTeX document for the diff
          cat << 'EOF' > diff.tex
          \documentclass[a4paper,11pt]{article}
          \usepackage[T1]{fontenc}
          \usepackage[utf8]{inputenc}
          \usepackage{geometry}
          \usepackage{xcolor}
          \usepackage{listings}
          \geometry{margin=1in}
          \setlength{\parindent}{0pt}

          \lstdefinestyle{gitdiff}{
              basicstyle=\ttfamily\small,
              morecomment=[l][\color{red}]{-},
              morecomment=[l][\color{green!60!black}]{+}
          }

          \lstset{
              style=gitdiff,
              breaklines=true,
              postbreak=\mbox{\textcolor{red}{$\hookrightarrow$}\space}
          }

          \begin{document}
          \section*{Git Diff}
          Commit range:\\
          \texttt{${{ github.event.before }}} -- \texttt{${{ github.sha }}}
          \bigskip
          \lstinputlisting{artifacts/diff/diff.txt}
          \end{document}
          EOF

          # Compile diff PDF
          latexmk -pdf -interaction=nonstopmode diff.tex
          mv diff.pdf artifacts/diff/

      # Step 4: Compile main PDF
      - name: Compile main PDF
        run: |
          mkdir -p artifacts/main
          latexmk -pdf -interaction=nonstopmode main.tex
          mv main.pdf artifacts/main/

    
      # Step 5: Spellcheck all .tex files
      - name: Spellcheck .tex files
        run: |
            mkdir -p artifacts/spellcheck
            for file in $(find . -name "*.tex"); do
                echo "Spellcheck for $file" > artifacts/spellcheck/$(basename "$file").txt
                hunspell -t -l "$file" >> artifacts/spellcheck/$(basename "$file").txt || true
            done


      # Step 6: Check bibliography
      - name: Check bibliography
        run: |
          mkdir -p artifacts/bib
          for file in $(find . -name "main.tex"); do
            pdflatex -interaction=nonstopmode "$file" >/dev/null 2>&1
            bibtex "${file%.tex}" >/dev/null 2>&1 || echo "Bibtex failed for $file" >> artifacts/bib/bib_errors.txt
          done

    # Step 7: Generate HTML report for artifacts
      - name: Generate HTML report
        run: |
            mkdir -p artifacts/html
            echo "<html><body><h1>Lab09 CI Artifacts</h1>" > artifacts/html/index.html
            echo "<h2>Git Diff</h2>" >> artifacts/html/index.html
            if [ -f artifacts/diff/diff.pdf ]; then
            echo "<embed src='../diff/diff.pdf' width='100%' height='600px' type='application/pdf'><br>" >> artifacts/html/index.html
            fi
            echo "<h2>Main PDF</h2>" >> artifacts/html/index.html
            if [ -f artifacts/main/main.pdf ]; then
            echo "<embed src='../main/main.pdf' width='100%' height='600px' type='application/pdf'><br>" >> artifacts/html/index.html
            fi
            echo "<h2>Spellcheck Reports</h2>" >> artifacts/html/index.html
            for file in artifacts/spellcheck/*.txt; do
            [ -e "$file" ] || continue
            echo "<h3>$(basename "$file")</h3>" >> artifacts/html/index.html
            echo "<pre>" >> artifacts/html/index.html
            cat "$file" >> artifacts/html/index.html
            echo "</pre>" >> artifacts/html/index.html
            done
            echo "<h2>Bibliography Check</h2>" >> artifacts/html/index.html
            if [ -f artifacts/bib/bib_errors.txt ]; then
            echo "<h3>Bibliography Errors</h3>" >> artifacts/html/index.html
            echo "<pre>" >> artifacts/html/index.html
            cat artifacts/bib/bib_errors.txt >> artifacts/html/index.html
            echo "</pre>" >> artifacts/html/index.html
            fi
            echo "</body></html>" >> artifacts/html/index.html

    # Step 8: Upload HTML report and artifacts
      - name: Upload HTML report and artifacts
        uses: actions/upload-artifact@v4
        with:
          name: lab09-html-report
          path: artifacts/html/index.html
